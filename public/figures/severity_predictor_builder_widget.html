<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Create-A-Cell Severity Predictor</title>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
<style>
  body {
    margin: 0; background: #1f1f1f; color: #f4f4f4;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 16px 16px 28px; }
  h1 { margin: 4px 0 12px; font-size: 22px; text-align: center; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }

  .card {
    border: 1px solid rgba(255,255,255,0.28); border-radius: 12px; padding: 12px;
    transition: transform 120ms ease, box-shadow 120ms ease; color: #fff;
    background-image: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.06));
  }
  .card:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.28); }
  .card h3 { margin: 0 0 8px; font-size: 14px; color: #ffffff; text-shadow: 0 1px 0 rgba(0,0,0,0.2); }

  .slider-row { display: flex; align-items: center; gap: 8px; }
  .slider-row input[type=range] { flex: 1; accent-color: #ffffff; }
  .value { font-family: monospace; min-width: 64px; text-align: right; color: #ffffff; filter: brightness(1.1); }

  select, input[type=number] {
    width: 100%; padding: 6px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.35); background: rgba(0,0,0,0.15); color: #fff;
  }

  button {
    padding: 10px 16px; border: 1px solid #fff; border-radius: 10px;
    background: #FF69B4; color: #fff; font-weight: 700; cursor: pointer;
  }
  button:active { transform: translateY(1px); }
  .actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center; margin-top: 14px; }

  .result {
    margin-top: 16px; padding: 14px; border-radius: 12px;
    background: #2e2e2e; border: 1px solid rgba(255,255,255,0.25);
  }
  .error { color: #ff9b9b; margin-top: 8px; }
</style>
</head>
<body>
<div class="container">
  <h1>Create a cell → Predict severity</h1>
  <div id="controls"></div>
  <div class="actions">
    <button id="predictBtn">Predict</button>
    <span id="status" style="color:#9fe0ff;"></span>
  </div>
  <div class="result" id="result">
    <div><b>Prediction:</b> <span id="predLabel">–</span></div>
    <div><b>Confidence:</b> <span id="predConf">–</span></div>
  </div>
  <div class="error" id="error"></div>
</div>

<script id="meta" type="application/json">{"feature_names": ["CCL5", "CCR1", "CD99", "PILRA", "ANXA1", "FPR1", "CD320", "JAML", "CD48", "CD244", "initial_clustering_B_cell", "initial_clustering_CD14", "initial_clustering_CD16", "initial_clustering_CD4", "initial_clustering_CD8", "initial_clustering_DCs", "initial_clustering_HSC", "initial_clustering_Lymph_prolif", "initial_clustering_MAIT", "initial_clustering_Mono_prolif", "initial_clustering_NK_16hi", "initial_clustering_NK_56hi", "initial_clustering_Plasmablast", "initial_clustering_Platelets", "initial_clustering_RBC", "initial_clustering_Treg", "initial_clustering_gdT", "initial_clustering_pDC", "Sex_Female", "Sex_Male", "Age_interval_(20, 29]", "Age_interval_(30, 39]", "Age_interval_(40, 49]", "Age_interval_(50, 59]", "Age_interval_(60, 69]", "Age_interval_(70, 79]", "Age_interval_(80, 89]", "Age_interval_(90, 99]", "Swab_result_Healthy", "Swab_result_Negative", "Swab_result_Positive", "Status_Covid", "Status_Healthy", "Status_Non_covid", "Smoker_Ex-smoker", "Smoker_Healthy", "Smoker_Non-smoker", "Smoker_Not_known", "Smoker_Smoker", "Days_from_onset_0", "Days_from_onset_1", "Days_from_onset_10", "Days_from_onset_11", "Days_from_onset_12", "Days_from_onset_13", "Days_from_onset_14", "Days_from_onset_15", "Days_from_onset_16", "Days_from_onset_17", "Days_from_onset_18", "Days_from_onset_2", "Days_from_onset_21", "Days_from_onset_22", "Days_from_onset_26", "Days_from_onset_27", "Days_from_onset_28", "Days_from_onset_3", "Days_from_onset_31", "Days_from_onset_4", "Days_from_onset_40", "Days_from_onset_42", "Days_from_onset_47", "Days_from_onset_5", "Days_from_onset_51", "Days_from_onset_6", "Days_from_onset_7", "Days_from_onset_8", "Days_from_onset_9", "Days_from_onset_Healthy", "Days_from_onset_Non_covid", "Days_from_onset_Not_known", "Site_Cambridge", "Site_Ncl", "Site_Sanger"], "numeric_cols": ["CCL5", "CCR1", "CD99", "PILRA", "ANXA1", "FPR1", "CD320", "JAML", "CD48", "CD244"], "numeric_stats": {"mean": [1.3581429848633442, 0.08719959403994211, 1.4771143095755628, 0.16544136164023154, 1.2752815638571704, 0.16301928832970422, 0.24833661632630225, 0.2995310717409646, 1.0455654621858523, 0.1305671315591447], "scale": [1.3711771219113211, 0.18980005828492033, 0.5869199745077328, 0.3748185174445362, 0.7629550514907641, 0.3710186508493513, 0.2408993603175925, 0.4276589844513901, 0.4838896428694331, 0.17329587758229312], "index": {"CCL5": 0, "CCR1": 1, "CD99": 2, "PILRA": 3, "ANXA1": 4, "FPR1": 5, "CD320": 6, "JAML": 7, "CD48": 8, "CD244": 9}}, "categorical_cols": ["initial_clustering", "Sex", "Age_interval", "Swab_result", "Status", "Smoker", "Days_from_onset", "Site"], "categorical_index": {"initial": {"clustering_B_cell": 10, "clustering_CD14": 11, "clustering_CD16": 12, "clustering_CD4": 13, "clustering_CD8": 14, "clustering_DCs": 15, "clustering_HSC": 16, "clustering_Lymph_prolif": 17, "clustering_MAIT": 18, "clustering_Mono_prolif": 19, "clustering_NK_16hi": 20, "clustering_NK_56hi": 21, "clustering_Plasmablast": 22, "clustering_Platelets": 23, "clustering_RBC": 24, "clustering_Treg": 25, "clustering_gdT": 26, "clustering_pDC": 27}, "Sex": {"Female": 28, "Male": 29}, "Age": {"interval_(20, 29]": 30, "interval_(30, 39]": 31, "interval_(40, 49]": 32, "interval_(50, 59]": 33, "interval_(60, 69]": 34, "interval_(70, 79]": 35, "interval_(80, 89]": 36, "interval_(90, 99]": 37}, "Swab": {"result_Healthy": 38, "result_Negative": 39, "result_Positive": 40}, "Status": {"Covid": 41, "Healthy": 42, "Non_covid": 43}, "Smoker": {"Ex-smoker": 44, "Healthy": 45, "Non-smoker": 46, "Not_known": 47, "Smoker": 48}, "Days": {"from_onset_0": 49, "from_onset_1": 50, "from_onset_10": 51, "from_onset_11": 52, "from_onset_12": 53, "from_onset_13": 54, "from_onset_14": 55, "from_onset_15": 56, "from_onset_16": 57, "from_onset_17": 58, "from_onset_18": 59, "from_onset_2": 60, "from_onset_21": 61, "from_onset_22": 62, "from_onset_26": 63, "from_onset_27": 64, "from_onset_28": 65, "from_onset_3": 66, "from_onset_31": 67, "from_onset_4": 68, "from_onset_40": 69, "from_onset_42": 70, "from_onset_47": 71, "from_onset_5": 72, "from_onset_51": 73, "from_onset_6": 74, "from_onset_7": 75, "from_onset_8": 76, "from_onset_9": 77, "from_onset_Healthy": 78, "from_onset_Non_covid": 79, "from_onset_Not_known": 80}, "Site": {"Cambridge": 81, "Ncl": 82, "Sanger": 83}}, "categorical_options": {"initial_clustering": ["B_cell", "CD14", "CD16", "CD4", "CD8", "DCs", "HSC", "Lymph_prolif", "MAIT", "Mono_prolif", "NK_16hi", "NK_56hi", "Plasmablast", "Platelets", "RBC", "Treg", "gdT", "pDC"], "Sex": ["Female", "Male"], "Age_interval": ["(20, 29]", "(30, 39]", "(40, 49]", "(50, 59]", "(60, 69]", "(70, 79]", "(80, 89]", "(90, 99]"], "Swab_result": ["Healthy", "Negative", "Positive"], "Status": ["Covid", "Healthy", "Non_covid"], "Smoker": ["Ex-smoker", "Healthy", "Non-smoker", "Not_known", "Smoker"], "Days_from_onset": ["0", "1", "10", "11", "12", "13", "14", "15", "16", "17", "18", "2", "21", "22", "26", "27", "28", "3", "31", "4", "40", "42", "47", "5", "51", "6", "7", "8", "9", "Healthy", "Non_covid", "Not_known"], "Site": ["Cambridge", "Ncl", "Sanger"]}, "gene_ranges": {"CCL5": {"min": 0.0, "max": 4.309452419999998, "median": 0.5460971}, "CCR1": {"min": 0.0, "max": 0.8203608719999985, "median": 0.010271939}, "CD99": {"min": 0.0, "max": 2.9504353339999994, "median": 1.4559685}, "PILRA": {"min": 0.0, "max": 1.6685382799999995, "median": 0.005652328}, "ANXA1": {"min": 0.0, "max": 2.791583771999997, "median": 1.3467392}, "FPR1": {"min": 0.0, "max": 1.5278745679999983, "median": 0.0035232033}, "CD320": {"min": 0.0, "max": 0.9832681739999922, "median": 0.1971795}, "JAML": {"min": 0.0, "max": 1.5470402639999978, "median": 0.095361754}, "CD48": {"min": 0.0, "max": 1.9205009599999978, "median": 1.133604}, "CD244": {"min": 0.0, "max": 0.6894425117999996, "median": 0.05516991}}, "class_labels": ["Asymptomatic", "Critical", "Healthy", "Mild", "Moderate", "Non_covid", "Severe"], "prob_output_name": "probabilities", "label_output_name": "label", "colors": {"Healthy": "#00CC96", "Asymptomatic": "#AB63FA", "Mild": "#FFA15A", "Moderate": "#19D3F3", "Severe": "#FF6692", "Critical": "#EF553B", "Non-covid": "#636EFA"}}</script>
<script>
(async function() {
  const meta = JSON.parse(document.getElementById('meta').textContent);
  const controls = document.getElementById('controls');
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  const predLabelEl = document.getElementById('predLabel');
  const predConfEl = document.getElementById('predConf');
  const resultBox = document.getElementById('result');

  // Smooth gradient across cards using your five shades
  const stops = ['#FF1493', '#FF69B4', '#FF8C00', '#BA55D3', '#9370DB'];

  function hexToRgb(hex) {
    const h = hex.replace('#', '');
    const v = parseInt(h, 16);
    return [(v >> 16) & 255, (v >> 8) & 255, v & 255];
  }
  function rgbToHex([r, g, b]) {
    const toHex = x => x.toString(16).padStart(2, '0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
  }
  function lerpColor(c1, c2, t) {
    const a = hexToRgb(c1), b = hexToRgb(c2);
    return rgbToHex([
      Math.round(a[0] + (b[0] - a[0]) * t),
      Math.round(a[1] + (b[1] - a[1]) * t),
      Math.round(a[2] + (b[2] - a[2]) * t),
    ]);
  }
  // Map index i over total n to a color along the multi-stop gradient
  function gradientColor(i, n) {
    if (n <= 1) return stops[0];
    const segs = stops.length - 1;
    const pos = (i / (n - 1)) * segs;
    const idx = Math.floor(pos);
    const t = pos - idx;
    const left = stops[Math.max(0, idx)];
    const right = stops[Math.min(segs, idx + 1)];
    return lerpColor(left, right, t);
  }

  function styleCard(card, i, nTotal) {
    const base = gradientColor(i, nTotal);
    card.style.background = base;
    card.style.borderColor = 'rgba(255,255,255,0.35)';
    card.style.color = '#ffffff';
    card.style.backgroundImage =
      'linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.06))';
  }

  // Build UI
  const grid = document.createElement('div');
  grid.className = 'grid';
  const totalCards = meta.numeric_cols.length + meta.categorical_cols.length;

  // Numeric sliders
  meta.numeric_cols.forEach((col, i) => {
    const range = meta.gene_ranges[col];
    const card = document.createElement('div');
    card.className = 'card';
    styleCard(card, i, totalCards);
    card.innerHTML = `<h3>${col}</h3>`;
    const row = document.createElement('div');
    row.className = 'slider-row';
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = range.min;
    slider.max = range.max;
    slider.step = ((range.max - range.min) / 200).toFixed(4);
    slider.value = range.median;
    slider.dataset.col = col;
    const val = document.createElement('span');
    val.className = 'value';
    val.textContent = Number(slider.value).toFixed(3);
    slider.addEventListener('input', () => val.textContent = Number(slider.value).toFixed(3));
    row.appendChild(slider);
    row.appendChild(val);
    card.appendChild(row);
    grid.appendChild(card);
  });

  // Categorical selects
  meta.categorical_cols.forEach((col, j) => {
    const cardIdx = meta.numeric_cols.length + j;
    const options = meta.categorical_options[col];
    const card = document.createElement('div');
    card.className = 'card';
    styleCard(card, cardIdx, totalCards);
    card.innerHTML = `<h3>${col}</h3>`;
    const select = document.createElement('select');
    select.dataset.col = col;
    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt;
      o.textContent = opt;
      select.appendChild(o);
    });
    card.appendChild(select);
    grid.appendChild(card);
  });

  controls.appendChild(grid);

  // Session (lazy init)
  let session = null;
  async function getSession() {
    if (!session) {
      statusEl.textContent = 'Loading model...';
      session = await ort.InferenceSession.create('random_forest_model.onnx');
      statusEl.textContent = 'Model loaded';
    }
    return session;
  }

  function buildFeatureVector() {
    const vec = new Float32Array(meta.feature_names.length);

    // numeric
    document.querySelectorAll('input[type=range]').forEach(el => {
      const col = el.dataset.col;
      const val = parseFloat(el.value);
      const idx = meta.numeric_stats.index[col];
      const mean = meta.numeric_stats.mean[meta.numeric_cols.indexOf(col)];
      const scale = meta.numeric_stats.scale[meta.numeric_cols.indexOf(col)] || 1e-9;
      vec[idx] = (val - mean) / scale;
    });

    // categorical (one-hot)
    document.querySelectorAll('select').forEach(sel => {
      const col = sel.dataset.col;
      const val = sel.value;
      const idxMap = meta.categorical_index[col];
      if (idxMap && idxMap.hasOwnProperty(val)) {
        vec[idxMap[val]] = 1;
      }
    });

    return vec;
  }

  function argmax(arr) { let m = 0; for (let i = 1; i < arr.length; i++) if (arr[i] > arr[m]) m = i; return m; }

  async function predict() {
    errorEl.textContent = '';
    const sess = await getSession();
    const inputVec = buildFeatureVector();
    const input = new ort.Tensor('float32', inputVec, [1, inputVec.length]);
    const outputs = await sess.run({ input });
    const probs = outputs[meta.prob_output_name].data;
    const best = argmax(probs);
    const label = meta.class_labels[best];
    const conf = (probs[best] * 100).toFixed(1) + '%';

    predLabelEl.textContent = label;
    predLabelEl.style.color = meta.colors[label] || '#fff';
    predConfEl.textContent = conf;

    // Tint result panel with predicted class color
    const c = meta.colors[label] || '#ffffff';
    resultBox.style.borderColor = c;
    resultBox.style.boxShadow = `0 0 0 3px ${c}30 inset`;
  }

  document.getElementById('predictBtn').addEventListener('click', () => {
    predict().catch(err => {
      console.error(err);
      errorEl.textContent = 'Prediction failed: ' + err.message;
    });
  });
})();
</script>
</body>
</html>
